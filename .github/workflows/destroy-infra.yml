name: Destroy Azure Infrastructure (Manual Approval Required)

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: "Type YES to confirm deleting ALL infrastructure"
        required: true
        default: "NO"

env:
  TF_VAR_location: "eastus"
  TF_VAR_resource_group_name: "rg-chandru-ecomm"
  TF_LOG: INFO

jobs:

  ###############################################################
  # STAGE 1 ‚Äî VALIDATE APPROVAL
  ###############################################################
  validate:
    name: Validate User Input
    runs-on: ubuntu-latest

    steps:
    - name: Check Approval
      run: |
        if [ "${{ github.event.inputs.confirm_destroy }}" != "YES" ]; then
          echo "‚ùå Confirmation failed. You must type YES to destroy."
          exit 1
        fi
        echo "‚úÖ Destroy confirmed. Proceeding..."

  ###############################################################
  # STAGE 2 ‚Äî LOGIN + SETUP BACKEND
  ###############################################################
  setup:
    name: Setup Terraform Backend
    needs: validate
    runs-on: ubuntu-latest

    outputs:
      storage: ${{ steps.b.outputs.storage }}
      container: ${{ steps.b.outputs.container }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Azure Login (OIDC)
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Read Storage Account + Container from backend.tf
      id: b
      run: |
        STORAGE=$(grep "storage_account_name" terraform/backend.tf | awk -F '"' '{print $2}')
        CONTAINER=$(grep "container_name" terraform/backend.tf | awk -F '"' '{print $2}')

        echo "storage=$STORAGE" >> $GITHUB_OUTPUT
        echo "container=$CONTAINER" >> $GITHUB_OUTPUT

        echo "Using storage: $STORAGE"
        echo "Using container: $CONTAINER"

  ###############################################################
  # STAGE 3 ‚Äî TERRAFORM INIT
  ###############################################################
  init:
    name: Terraform Init
    needs: setup
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.9.0"

    - name: Terraform Init
      run: |
        cd terraform
        terraform init
      env:
        ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        ARM_USE_OIDC: true

  ###############################################################
  # STAGE 4 ‚Äî TERRAFORM DESTROY
  ###############################################################
  destroy:
    name: Destroy All Resources
    needs: init
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Login to Azure
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Terraform Destroy
      run: |
        cd terraform
        terraform destroy -auto-approve
      env:
        ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        ARM_USE_OIDC: true

  ###############################################################
  # STAGE 5 ‚Äî CLEANUP CHECK
  ###############################################################
  cleanup:
    name: Verify Cleanup
    needs: destroy
    runs-on: ubuntu-latest

    steps:
    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Check If Resource Group Still Exists
      run: |
        if az group exists -n ${{ env.TF_VAR_resource_group_name }}; then
          echo "‚ö†Ô∏è Resource group still exists. Manual cleanup may be required."
        else
          echo "üéâ All resources successfully destroyed!"
        fi
