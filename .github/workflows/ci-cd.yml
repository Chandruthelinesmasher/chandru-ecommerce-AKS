name: Full Infra + App Deployment (5-Stage Pipeline)

on:
  push:
    branches: [ "main" ]

env:
  TF_VAR_location: "eastus"
  TF_VAR_resource_group_name: "rg-chandru-ecomm"
  TF_VAR_node_vm_size: "Standard_DC2s_v3"
  TF_LOG: INFO

jobs:

  # ---------------------------------------------------------
  # STAGE 1 ‚Äî PREPARE ENVIRONMENT
  # ---------------------------------------------------------
  prepare:
    name: Stage 1 ‚Äî Prepare Environment
    runs-on: ubuntu-latest

    outputs:
      tf_storage: ${{ steps.store.outputs.tf_storage }}
      tf_container: ${{ steps.store.outputs.tf_container }}

    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Login to Azure via OIDC
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Prepare Terraform Remote Backend
      id: store
      run: |
        RESOURCE_GROUP=${{ env.TF_VAR_resource_group_name }}
        STORAGE="tf${GITHUB_RUN_ID}state"
        STORAGE=$(echo $STORAGE | tr -cd '[:alnum:]' | tr '[:upper:]' '[:lower:]')
        CONTAINER="tfstate"

        az group create -n $RESOURCE_GROUP -l ${{ env.TF_VAR_location }} || true
        az storage account create -n $STORAGE -g $RESOURCE_GROUP -l ${{ env.TF_VAR_location }} --sku Standard_LRS
        az storage container create --name $CONTAINER --account-name $STORAGE

        echo "tf_storage=$STORAGE" >> $GITHUB_OUTPUT
        echo "tf_container=$CONTAINER" >> $GITHUB_OUTPUT


  # ---------------------------------------------------------
  # STAGE 2 ‚Äî TERRAFORM APPLY (INFRA PROVISIONING)
  # ---------------------------------------------------------
  terraform:
    name: Stage 2 ‚Äî Terraform Provision Infrastructure
    runs-on: ubuntu-latest
    needs: prepare

    outputs:
      acr_name: ${{ steps.tfout.outputs.acr_name }}
      acr_login_server: ${{ steps.tfout.outputs.acr_login_server }}
      aks_name: ${{ steps.tfout.outputs.aks_name }}
      resource_group: ${{ steps.tfout.outputs.resource_group }}

    steps:
    - uses: actions/checkout@v4

    - uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.9.0"

    - name: Configure Terraform Backend
      run: |
        cat > terraform/backend.tf <<EOF
        terraform {
          backend "azurerm" {
            resource_group_name  = "${{ env.TF_VAR_resource_group_name }}"
            storage_account_name = "${{ needs.prepare.outputs.tf_storage }}"
            container_name       = "${{ needs.prepare.outputs.tf_container }}"
            key                  = "terraform.tfstate"
          }
        }
        EOF

    - name: Terraform Init
      run: cd terraform && terraform init

    - name: Terraform Apply
      run: cd terraform && terraform apply -auto-approve

    - name: Capture Terraform Outputs
      id: tfout
      run: |
        cd terraform
        echo "acr_login_server=$(terraform output -raw acr_login_server)" >> $GITHUB_OUTPUT
        echo "acr_name=$(terraform output -raw acr_name)" >> $GITHUB_OUTPUT
        echo "aks_name=$(terraform output -raw aks_name)" >> $GITHUB_OUTPUT
        echo "resource_group=$(terraform output -raw resource_group)" >> $GITHUB_OUTPUT


  # ---------------------------------------------------------
  # STAGE 3 ‚Äî BUILD & PUSH DOCKER IMAGE
  # ---------------------------------------------------------
  docker:
    name: Stage 3 ‚Äî Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: terraform

    steps:
    - uses: actions/checkout@v4

    - name: Login to Azure ACR
      run: az acr login --name ${{ needs.terraform.outputs.acr_name }}

    - name: Build Image
      run: |
        docker build -t ${{ needs.terraform.outputs.acr_login_server }}/product:${{ github.sha }} ./services/product

    - name: Push Image
      run: |
        docker push ${{ needs.terraform.outputs.acr_login_server }}/product:${{ github.sha }}

    - name: Attach ACR to AKS
      run: |
        az aks update \
          --name ${{ needs.terraform.outputs.aks_name }} \
          --resource-group ${{ needs.terraform.outputs.resource_group }} \
          --attach-acr ${{ needs.terraform.outputs.acr_name }}


  # ---------------------------------------------------------
  # STAGE 4 ‚Äî DEPLOY TO KUBERNETES
  # ---------------------------------------------------------
  deploy:
    name: Stage 4 ‚Äî Deploy to AKS
    runs-on: ubuntu-latest
    needs: docker

    steps:
    - uses: actions/checkout@v4

    - name: Set AKS Context
      uses: azure/aks-set-context@v3
      with:
        cluster-name: ${{ needs.terraform.outputs.aks_name }}
        resource-group: ${{ needs.terraform.outputs.resource_group }}

    - name: Deploy Namespace + Services
      run: |
        kubectl apply -f k8s/namespace.yaml

    - name: Deploy Product Service
      run: |
        sed "s|IMAGE_REPLACED_BY_CI|${{ needs.terraform.outputs.acr_login_server }}/product:${{ github.sha }}|" k8s/product-deployment.yaml | kubectl apply -f -

    - name: Deploy K8s Additional Resources
      run: |
        kubectl apply -f k8s/product-service.yaml
        kubectl apply -f k8s/product-hpa.yaml
        kubectl apply -f k8s/product-pdb.yaml
        kubectl apply -f k8s/ingress.yaml

    - name: Wait for Pods
      run: |
        kubectl wait --for=condition=ready pod -l app=product -n ecomm --timeout=300s || true


  # ---------------------------------------------------------
  # STAGE 5 ‚Äî POST DEPLOY VALIDATION
  # ---------------------------------------------------------
  validate:
    name: Stage 5 ‚Äî Post-Deploy Validation
    runs-on: ubuntu-latest
    needs: deploy

    steps:
    - name: Get Load Balancer IP
      run: |
        echo "Waiting for Ingress IP..."
        for i in {1..30}; do
          IP=$(kubectl get svc nginx-ingress-ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].ip}' || echo "")
          if [ -n "$IP" ]; then
            echo "APP_URL=http://$IP" >> $GITHUB_ENV
            break
          fi
          sleep 10
        done

    - name: Print Application URL
      run: |
        echo ""
        echo "============================================="
        echo " üåê YOUR APPLICATION IS LIVE!"
        echo " URL: $APP_URL"
        echo "============================================="
